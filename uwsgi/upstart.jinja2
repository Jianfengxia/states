# {{ pillar['message_do_not_modify'] }}
# ubuntu upstart script for uwsgi
{% set ksm = grains['virtual'] == 'kvm' and salt['file.file_exists']('/sys/kernel/mm/ksm/run') %}
start on filesystem or runlevel [2345]
stop on runlevel [!2345]

respawn
umask 022

env LC_ALL=en_US.UTF-8
env LANG=en_US.UTF-8

{% if ksm %}
pre-start script
    echo 1 > /sys/kernel/mm/ksm/run
end script
{% endif %}

exec /usr/local/uwsgi/uwsgi --uid www-data --gid www-data --threaded-logger {% if 'graylog2_address' in pillar %}--logger graylog2:{{ pillar['graylog2_address'] }}:12201,{{ grains['id'] }}{% else %}--log-syslog uwsgi{% endif %}{% if 'graphite_address' in pillar %} --carbon-id emperor --carbon {{ pillar['graphite_address'] }}:2003{% endif %} --emperor /etc/uwsgi/ --no-orphans --die-on-term{% if ksm %} --ksm=10{% endif %}
