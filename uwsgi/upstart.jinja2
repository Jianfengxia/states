{#-
Use of this source code is governed by a BSD license that can be found
in the doc/license.rst file.

Author: Bruno Clermont <bruno@robotinfra.com>
Maintainer: Van Pham Diep <favadi@robotinfra.com>
-#}
# {{ salt['pillar.get']('message_do_not_modify') }}
# ubuntu upstart script for uwsgi
{% set ksm = grains['virtual'] == 'kvm' and salt['file.file_exists']('/sys/kernel/mm/ksm/run') %}
start on filesystem or runlevel [2345]
stop on runlevel [!2345]

respawn
umask 022

env LC_ALL=en_US.UTF-8
env LANG=en_US.UTF-8

{%- if ksm %}
pre-start script
    echo 1 > /sys/kernel/mm/ksm/run
end script
{%- endif %}

exec {{ extracted_dir }}/uwsgi --yaml /etc/uwsgi.yml
