{#-
Use of this source code is governed by a BSD license that can be found
in the doc/license.rst file.

Author: Bruno Clermont <bruno@robotinfra.com>
Maintainer: Van Pham Diep <favadi@robotinfra.com>

To use this template, extends it and define blocks that you want to replace,
This template need:
- pillar data for this app
- context variable(s): chdir, appname, [wsgi_file], [virtualenv], [django_settings], [module], [uid], [gid]
[something] means optional
-#}
{%- set cheaper = salt['pillar.get'](appname + ':cheaper', False) %}
{%- set workers = salt['pillar.get'](appname + ':workers', 1) %}
{%- set timeout = salt['pillar.get'](appname + ':timeout', 60) %}
{%- set idle = salt['pillar.get'](appname + ':idle', 300) %}
uwsgi:
{%- block header %}
{%- endblock %}
  master: true
  workers: {{ workers }}
  harakiri: {{ timeout }}
  harakiri-verbose: {% if salt['pillar.get']('debug', False) %}false{% else %}true{% endif %}
{%- if django_settings|default(False) %}
  env: DJANGO_SETTINGS_MODULE={{ django_settings }}
{%- endif %}
{%- if module|default(False) %}
  module: {{ module }}
{%- endif %}
{%- if cheaper %}
  {%- if cheaper > 0 %}
  cheaper: {{ cheaper }}
  {%- else %}
  cheap: true
  {%- endif %}
  {%- if workers == 1 and cheaper == 0 %}
  idle: {{ idle }}
  {%- endif %}
{%- endif %}
{%- if grains['virtual'] == 'kvm' and salt['file.file_exists']('/sys/kernel/mm/ksm/run') %}
  ksm: 20
{%- endif %}
  lazy-apps: true
  uid: {{ uid|default("www-data") }}
  gid: {{ gid|default("www-data") }}
  procname: {{ appname }}-worker
  procname-master: {{ appname }}-master
  socket: /var/lib/uwsgi/{{ appname }}.sock
  stats: /var/lib/uwsgi/{{ appname }}-stats.sock
  chdir: {{ chdir }}
{%- if wsgi_file|default(False) %}
  wsgi-file: {{ wsgi_file }}
{%- endif %}
{%- if virtualenv|default(False) %}
  virtualenv: {{ virtualenv }}
{%- endif %}
  threaded-logger: true
  no-orphans: true
  logger: syslog:uwsgi-{{ appname }}
{%- if salt['pillar.get']('debug', False) %}
  req-logger: syslog:uwsgi-{{ appname }}
{%- endif %}
{%- set graphite_address = salt['pillar.get']('graphite_address', False) %}
{%- if graphite_address %}
  carbon-id: {{ appname }}
  {%- if salt['dig.check_ip'](graphite_address) %}
  carbon: {{ graphite_address }}:2003
  {%- else %}
    {%- set resolved_ip = salt['dig.A'](graphite_address) %}
    {%- if resolved_ip %}
  carbon: {{ resolved_ip[0] }}:2003
    {%- else %}
{#-
  The domain name {{ graphite_address }} is invalid. carbon support is disabled.
#}
    {%- endif %}
  {%- endif %}
{%- endif %}
  chmod-socket: 660
  chown-socket: {{ uid|default('www-data') }}:www-data
{%- if php_settings|default(False) %}
{{ php_settings }}
{%- endif %}
{%- block footer %}
{%- endblock %}
