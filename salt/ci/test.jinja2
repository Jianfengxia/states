#!/bin/bash
# {{ pillar['message_do_not_modify'] }}
cd common
./bootstrap_archive.py ../pillar . > /srv/salt/jenkins_archives/bootstrap-archive-$BUILD_NUMBER.tar.gz
sudo salt-cloud -p hvn-test integration-$JOB_NAME-$BUILD_NUMBER
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" cp.get_file salt://jenkins_archives/bootstrap-archive-$BUILD_NUMBER.tar.gz /tmp/bootstrap-archive-$BUILD_NUMBER.tar.gz
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" archive.tar xzf /tmp/bootstrap-archive-$BUILD_NUMBER.tar.gz cwd=/
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" cmd.run /root/salt/states/test/integration.py
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" cmd.run "/root/salt/states/test/integration.py > /root/salt/$JOB_NAME-$BUILD_NUMBER-stdout.log 2> /root/salt/$JOB_NAME-$BUILD_NUMBER-stderr.log"
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" cmd.run "xz /root/salt/$JOB_NAME-$BUILD_NUMBER-*.log"
