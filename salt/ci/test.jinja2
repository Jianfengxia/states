#!/bin/bash
# {{ pillar['message_do_not_modify'] }}
set -e
set -x
cd common
./bootstrap_archive.py ../pillar ../non-common > /srv/salt/jenkins_archives/$JOB_NAME-$BUILD_NUMBER.tar.gz
sudo salt-cloud -p ci-minion integration-$JOB_NAME-$BUILD_NUMBER
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" cmd.run "hostname integration-$JOB_NAME-$BUILD_NUMBER"
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" --output json cp.get_file salt://jenkins_archives/$JOB_NAME-$BUILD_NUMBER.tar.gz /tmp/bootstrap-archive.tar.gz | /usr/local/bin/retcode_check.py
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" --output json archive.tar xzf /tmp/bootstrap-archive.tar.gz cwd=/ | /usr/local/bin/retcode_check.py
sudo salt -t 600 "integration-$JOB_NAME-$BUILD_NUMBER" --output json cmd.run_all "salt-call -c /root/salt/states/test/ state.sls test.jenkins" | /usr/local/bin/retcode_check.py
sleep 15
sudo salt -t 86400 "integration-$JOB_NAME-$BUILD_NUMBER" cmd.run "/root/salt/states/test/integration.py $* > /root/salt/stdout.log 2> /root/salt/stderr.log"
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" --output json cmd.run_all "xz /root/salt/*.log" | /usr/local/bin/retcode_check.py
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" --output json cp.push /root/salt/stderr.log.xz | /usr/local/bin/retcode_check.py
sudo /usr/local/bin/import_test_data.py stderr.log.xz integration-$JOB_NAME-$BUILD_NUMBER $WORKSPACE
xz -d -c $WORKSPACE/$BUILD_NUMBER-stderr.log.xz
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" --output json cp.push /root/salt/stdout.log.xz | /usr/local/bin/retcode_check.py
sudo /usr/local/bin/import_test_data.py stdout.log.xz integration-$JOB_NAME-$BUILD_NUMBER $WORKSPACE
sudo salt "integration-$JOB_NAME-$BUILD_NUMBER" --output json cp.push /root/salt/TEST-States.xml | /usr/local/bin/retcode_check.py
sudo /usr/local/bin/import_test_data.py TEST-States.xml integration-$JOB_NAME-$BUILD_NUMBER $WORKSPACE
sudo salt-cloud --destroy --assume-yes integration-$JOB_NAME-$BUILD_NUMBER
mv /srv/salt/jenkins_archives/$JOB_NAME-$BUILD_NUMBER.tar.gz $WORKSPACE/bootstrap-archive-$BUILD_NUMBER.tar.gz
