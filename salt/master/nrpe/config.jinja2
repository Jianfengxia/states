{#- Usage of this is governed by a license that can be found in doc/license.rst -#}

{%- set timeout = 30 -%}
{%- set workers = salt['pillar.get']('salt_master:workers', 5) -%}

# {{ salt['pillar.get']('message_do_not_modify') }}

salt_master_procs:
  description: Salt Master Daemon
  command: '/usr/lib/nagios/plugins/check_procs -c {{ workers }}:{{ workers|int + 10 }} -C salt-master -u root'

salt_master_publish_port:
  description: Salt Master Local Port Publish
  command: /usr/lib/nagios/plugins/check_tcp -H 127.0.0.1 -p 4505 -t {{ timeout }}
  timeout: {{ timeout }}
  dependencies:
    - salt_master_procs

salt_master_publish_port_remote:
  description: Salt Master Remote Port Publish
  check: check_tcp!4505
  passive: False
  dependencies:
    - salt_master_publish_port

salt_master_return_port:
  description: Salt Master Local Port Return
  command: /usr/lib/nagios/plugins/check_tcp -H 127.0.0.1 -p 4506 -t {{ timeout }}
  timeout: {{ timeout }}
  dependencies:
    - salt_master_procs

salt_master_return_port_remote:
  description: Salt Master Remote Port Return
  check: check_tcp!4506
  timeout: {{ timeout }}
  passive: False
  dependencies:
    - salt_master_return_port

{%- block salt_master_mine -%}
    {%- if not salt['pillar.get']('__test__', False) %}
salt_master_mine:
  description: Salt Master Unfinished Minions
  check_interval: {{ 12 * 60 }} {#- 12 hours  #}
  freshness_threshold: {{ ((12 * 60) + 10) * 60 }} {#- 12 hours + 10 minutes #}
  dependencies:
    - salt_master_procs
    {#- no alert if load is too high #}
    - load_average
  timeout: 55
  arguments:
    freshness: {{ 12 * 60 + 20 }} {#- cron interval + timeout + 5 mins #}
{#- sudo for reading salt config files #}
  command: sudo /usr/lib/nagios/plugins/check_mine_minions.py --formula=salt.master --check=salt_master_mine
    {%- endif -%}
{%- endblock -%}
