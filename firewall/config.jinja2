{#-
Use of this source code is governed by a BSD license that can be found
in the doc/license.rst file.

-#}
{%- set mine = salt['mine.get']('*', 'monitoring.data') -%}
{%- set pillars_ip = salt['pillar.get']('ip_addresses', []) -%}
# {{ salt['pillar.get']('message_do_not_modify') }}
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
{%- if grains['osrelease']|float < 12.04 %}
:INPUT ACCEPT [0:0]
{%- endif %}
:OUTPUT ACCEPT [0:0]
COMMIT
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
COMMIT
*filter
:OUTPUT ACCEPT [0:0]
{%- set filter = salt['pillar.get']('firewall:filter', {}) -%}
{%- if filter|length > 0 %}
:INPUT {% if grains['virtual'] == 'openvzve' %}ACCEPT{% else %}DROP{% endif %} [0:0]
:FORWARD {% if grains['virtual'] == 'openvzve' %}ACCEPT{% else %}DROP{% endif %} [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
{%- for host in mine -%}
  {#- if private == public only process public -#}
  {%- if mine[host]['ip_addrs']['public'] == mine[host]['ip_addrs']['private'] -%}
    {%- set addr_types = ['public'] -%}
  {%- else -%}
    {%- set addr_types = ['public', 'private'] -%}
  {%- endif -%}
  {%- for addr_type in addr_types -%}
    {%- if mine[host]['ip_addrs'][addr_type] not in pillars_ip %}
-A INPUT -i {% if grains['virtual'] == 'openvzve' %}venet0{% else %}eth0{% endif %} -s {{ mine[host]['ip_addrs'][addr_type] }}/32 -j ACCEPT
    {%- endif -%}
  {%- endfor -%}
{%- endfor -%}
{%- for host in pillars_ip %}
-A INPUT -i {% if grains['virtual'] == 'openvzve' %}venet0{% else %}eth0{% endif %} -s {{ host }}/32 -j ACCEPT
{%- endfor -%}
{%- for protocol in filter -%}
  {%- set ports = salt['pillar.get']('firewall:filter:' + protocol, []) -%}
  {%- if ports|length == 1 %}
-A INPUT -i {% if grains['virtual'] == 'openvzve' %}venet0{% else %}eth0{% endif %} -p {{ protocol }} -m {{ protocol }} --dport {{ ports[0] }} -j ACCEPT
  {%- else %}
-A INPUT -i {% if grains['virtual'] == 'openvzve' %}venet0{% else %}eth0{% endif %} -p {{ protocol }} -m multiport --dports {% for port in ports %}{{ port }}{% if not loop.last %},{% endif %}{% endfor %} -j ACCEPT
  {%- endif %}{# if length == 1 -#}
  {%- if grains['virtual'] == 'openvzve' %}
-A INPUT -i venet0 -j DROP
  {%- endif -%}
{%- endfor -%}
{%- else %}{# if filter at all#}
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
{% endif %}
COMMIT
