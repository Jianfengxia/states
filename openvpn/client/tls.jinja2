{#- Usage of this is governed by a license that can be found in doc/license.rst -#}

{%- extends "openvpn/client/base.jinja2" %}
{%- from 'macros.jinja2' import first_ipv6 with context %}
{%- set default_interface = salt['pillar.get']('network_interface', 'eth0') %}
{%- set openvpn_interface = salt['pillar.get']('openvpn:public_interface', False)|default(default_interface, boolean=True) %}
{%- if 'availabilityZone' in salt['grains.ls']() %}
  {%- set remote_address = grains['public-ipv4'] %}
{%- else %}
  {%- set remote_address = salt['network.ip_addrs'](openvpn_interface)[0] %}
{%- endif %}

{%- block authentication_mode %}
client
{%- set protocol = vpn_instance['protocol']|default('udp') %}
{%- if protocol.endswith("6") and first_ipv6 %}
remote {{ first_ipv6 }} {{ vpn_instance['port']|default(1194) }} {{ protocol }}
{%- endif %}
remote {{ remote_address }} {{ vpn_instance['port']|default(1194) }} {{ (protocol|list)[:-1]|join }}

ca ca.crt
cert {{ client }}.crt
key {{ client }}.key
remote-cert-tls server
{%- endblock authentication_mode %}
