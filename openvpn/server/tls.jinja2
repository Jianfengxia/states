{#- Usage of this is governed by a license that can be found in doc/license.rst -#}

{%- extends "openvpn/server/base.jinja2" %}

{%- set vpn_instance = salt['pillar.get']('openvpn:servers:' ~ instance) %}
{%- set topology = salt['pillar.get']('openvpn:servers:' ~ instance + ':topology', 'subnet') %}
{%- set server = vpn_instance['server']%}
{%- set server_octets = server.split()[0].split('.') %}
{%- set server_netmask = server.split()[1] %}
{%- set server_last_octet = server_octets[3]|int + 1 %}
{%- set server_ip = server_octets[0] + "." + server_octets[1] + "." + server_octets[2] + "." + server_last_octet|string %}

{%- if topology == "subnet" -%}
  {%- block topology %}
mode server
tls-server
topology "subnet"
push "topology subnet"
push "route-gateway {{ server_ip }}"
  {%- endblock topology -%}
{%- endif %}

{%- block authentication_mode %}
ca /etc/openvpn/ca.crt
cert /etc/openvpn/{{ instance }}/server.crt
key /etc/openvpn/{{ instance }}/server.key
dh /etc/openvpn/dh.pem
  {%- if topology == "subnet" %}
ifconfig {{ server_ip }} {{ server_netmask }}
ifconfig-pool {{ vpn_instance['ifconfig-pool'] }} {{ server_netmask }}
  {%- else %}
server {{ server }}
  {%- endif %}
ifconfig-pool-persist /var/lib/openvpn/{{ instance }}.ipp
client-config-dir /etc/openvpn/{{ instance }}/ccd
crl-verify /etc/openvpn/{{ instance }}/crl.pem
{%- endblock authentication_mode %}
