{#-
Use of this source code is governed by a BSD license that can be found
in the doc/license.rst file.

Author: Viet Hung Nguyen <hvn@robotinfra.com>
Maintainer: Viet Hung Nguyen <hvn@robotinfra.com>
-#}
# {{ salt['pillar.get']('message_do_not_modify') }}
{#-
 Check http://www.clamav.net/mirrors.html for a list of Clamav mirrors
#}
DatabaseOwner clamav
NotifyClamd /etc/clamav/clamd.conf
LogSyslog true
LogFacility LOG_DAEMON
LogFileMaxSize 0
LogTime true
Foreground false
{%- if salt['pillar.get']('debug', False) %}
Debug true
LogVerbose true
{%- else %}
LogVerbose false
Debug false
{%- endif %}
MaxAttempts 5
DatabaseDirectory /var/lib/clamav
AllowSupplementaryGroups false
PidFile /var/run/clamav/freshclam.pid
ConnectTimeout {{ salt['pillar.get']('clamav:connect_timeout', 30) }}
ReceiveTimeout {{ salt['pillar.get']('clamav:receive_timeout', 30) }}
TestDatabases yes
CompressLocalDatabase no
Bytecode true
{#- Check for new database 24 times a day #}
Checks {{ salt['pillar.get']('clamav:times_of_check', 24) }}

{%- if salt['pillar.get']('files_archive', False) and not salt['pillar.get']('clamav:db_mirrors', False) -%}
    {%- set netloc = salt['common.urlparse'](salt['pillar.get']('files_archive', False)).netloc -%}
        {%- if netloc %}
ScriptedUpdates no
PrivateMirror {{ netloc }}
        {%- else -%}
            {#- netloc == '' mean it's a local mirror, use default #}
DatabaseMirror db.local.clamav.net
DatabaseMirror database.clamav.net
        {%- endif -%}
{%- else %}
ScriptedUpdates yes
  {%- for mirror in salt['pillar.get']('clamav:db_mirrors', False)|default(('db.local.clamav.net', 'database.clamav.net'), boolean=True) %}
DatabaseMirror {{ mirror }}
  {%- endfor -%}
{%- endif -%}
{%- for mirror in salt['pillar.get']('clamav:dns_db', False)|default(('current.cvd.clamav.net',), boolean=True) %}
DNSDatabaseInfo {{ mirror }}
{%- endfor %}
OnUpdateExecute touch /var/lib/clamav/last-update
